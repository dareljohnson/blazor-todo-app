@page "/"
@using BlazorTodo.Models
@using BlazorTodo.Services
@using Microsoft.FluentUI.AspNetCore.Components
@rendermode InteractiveServer
@inject ITodoService TodoService
@inject IDialogService DialogService

<PageTitle>Todo App</PageTitle>

<div class="todo-app">
    <div class="todo-header">
        <h2>My Tasks</h2>
        <div class="filter-buttons">
            <button class="filter-btn @(CurrentFilter == TodoFilter.All ? "active" : "")"
                    @onclick="() => SetFilter(TodoFilter.All)">
                All (@_totalCount)
            </button>
            <button class="filter-btn @(CurrentFilter == TodoFilter.Active ? "active" : "")"
                    @onclick="() => SetFilter(TodoFilter.Active)">
                Active (@_activeCount)
            </button>
            <button class="filter-btn @(CurrentFilter == TodoFilter.Completed ? "active" : "")"
                    @onclick="() => SetFilter(TodoFilter.Completed)">
                Completed (@_completedCount)
            </button>
        </div>
    </div>

    <TodoForm OnTodoCreated="HandleTodoCreated" />

    @if (_isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading todos...</p>
        </div>
    }
    else if (!_filteredTodos.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">📝</div>
            <h3>No todos yet</h3>
            <p>@GetEmptyStateMessage()</p>
        </div>
    }
    else
    {
        <TodoList Todos="_filteredTodos"
                  OnTodoToggled="HandleTodoToggled"
                  OnTodoUpdated="HandleTodoUpdated"
                  OnDeleteRequested="HandleDeleteRequested" />

        <div class="pagination-container">
            <div class="pagination-info">
                Showing @_pagedResult.Items.Count() of @_pagedResult.TotalCount todos
            </div>
            <div class="pagination-controls">
                <button class="btn btn-secondary" 
                        @onclick="GoToPreviousPage" 
                        disabled="@(!_pagedResult.HasPreviousPage)">
                    ← Previous
                </button>
                <span class="page-indicator">
                    Page @_pagedResult.PageNumber of @_pagedResult.TotalPages
                </span>
                <button class="btn btn-secondary" 
                        @onclick="GoToNextPage" 
                        disabled="@(!_pagedResult.HasNextPage)">
                    Next →
                </button>
            </div>
        </div>
    }
</div>

@code {
    private PagedResult<TodoItemDto> _pagedResult = new() { PageSize = 10 };
    private List<TodoItemDto> _filteredTodos = new();
    private bool _isLoading = true;
    private TodoFilter CurrentFilter { get; set; } = TodoFilter.All;
    private const int PageSize = 10;
    private int _currentPage = 1;
    private int _totalCount = 0;
    private int _activeCount = 0;
    private int _completedCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadTodosAsync();
    }

    private async Task LoadTodosAsync()
    {
        _isLoading = true;
        try
        {
            _pagedResult = await TodoService.GetPagedAsync(_currentPage, PageSize);
            _filteredTodos = _pagedResult.Items.ToList();
            
            // Load counts for all filter buttons
            var allTodos = (await TodoService.GetAllAsync()).ToList();
            _totalCount = allTodos.Count;
            _activeCount = allTodos.Count(t => !t.IsCompleted);
            _completedCount = allTodos.Count(t => t.IsCompleted);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task GoToNextPage()
    {
        if (_pagedResult.HasNextPage)
        {
            _currentPage++;
            await LoadTodosAsync();
        }
    }

    private async Task GoToPreviousPage()
    {
        if (_pagedResult.HasPreviousPage)
        {
            _currentPage--;
            await LoadTodosAsync();
        }
    }

    private async Task SetFilter(TodoFilter filter)
    {
        CurrentFilter = filter;
        _currentPage = 1;
        await LoadTodosAsync();
    }

    private async Task HandleTodoCreated(TodoItemDto todo)
    {
        await LoadTodosAsync();
    }

    private async Task HandleTodoToggled(Guid id)
    {
        await TodoService.ToggleCompleteAsync(id);
        await LoadTodosAsync();
    }

    private async Task HandleDeleteRequested((Guid Id, string Title) todoInfo)
    {
        var dialog = await DialogService.ShowConfirmationAsync(
            message: $"Are you sure you want to delete '{todoInfo.Title}'?\n\nThis action cannot be undone.",
            primaryText: "Delete",
            secondaryText: "Cancel",
            title: "Delete Todo"
        );

        var result = await dialog.Result;
        if (result is not null && !result.Cancelled)
        {
            await HandleTodoDeleted(todoInfo.Id);
        }
    }

    private async Task HandleTodoDeleted(Guid id)
    {
        await TodoService.DeleteAsync(id);
        await LoadTodosAsync();
    }

    private async Task HandleTodoUpdated(TodoItemDto todo)
    {
        await TodoService.UpdateAsync(todo);
        await LoadTodosAsync();
    }

    private string GetEmptyStateMessage()
    {
        return CurrentFilter switch
        {
            TodoFilter.Active => "All tasks completed! Great job! 🎉",
            TodoFilter.Completed => "No completed tasks yet. Start checking off items!",
            _ => "Add your first task using the form above."
        };
    }

    private enum TodoFilter
    {
        All,
        Active,
        Completed
    }
}
